<!DOCTYPE html><html><head><title>Haskell by Example: Timers</title><link rel="stylesheet" href="../css/main.css"><link rel="stylesheet" href="../css/prism.css"><script src="../js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Timers</h1><a href="https://gobyexample.com/timers">original</a><pre><code class="language-haskell">import Control.Concurrent
import Control.Concurrent.STM

main = do
    timer1 &lt;- newTimer (2 * 1000000)
    waitTimer timer1
    putStrLn &quot;Timer 1 expired&quot;

    timer2 &lt;- newTimer (1 * 1000000)
    forkIO $ do
        waitTimer timer2
        putStrLn &quot;Timer 2 expired&quot;
    stopTimer timer2
    putStrLn &quot;Timer 2 stopped&quot;

data State = Start | Stop
type Timer = (TVar State, TMVar ())

waitTimer :: Timer -&gt; IO ()
waitTimer (_, timer) = atomically $ readTMVar timer

stopTimer :: Timer -&gt; IO ()
stopTimer (state, _) = atomically $ writeTVar state Stop

newTimer :: Int -&gt; IO Timer
newTimer n = do
    state &lt;- atomically $ newTVar Start
    timer &lt;- atomically $ newEmptyTMVar
    forkIO $ do
        threadDelay n
        atomically $ do
            runState &lt;- readTVar state
            case runState of
                Start -&gt; putTMVar timer ()
                Stop  -&gt; return ()
    return (state, timer)
</code></pre>
<pre><code class="language-bash">$ runhaskell timers.hs
Timer 1 expired
Timer 2 stopped
</code></pre><a href="../">back to index</a></div></body></html>